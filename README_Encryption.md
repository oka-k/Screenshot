# 認証情報暗号化機能 - 運用ガイド

## 概要
このツールは、Googleサービスアカウントの認証情報（JSONキーファイル）を暗号化して保護し、従業員に元の認証情報を渡すことなく配布できる仕組みを提供します。

## 管理者向けワークフロー

### 初回セットアップ（管理者のみ）

1. **必要ファイルの準備**
   ```
   service-account-key.json をプロジェクトフォルダに配置
   ```

2. **従業員配布用ファイルの作成**
   ```batch
   prepare_for_employees_en.bat
   ```
   実行すると：
   - パスワード設定を求められます（2回入力）
   - 自動的に暗号化処理
   - ビルドまで完了
   - dist/フォルダに配布用ファイル生成

3. **配布ファイルの確認**
   ```
   dist/
   ├── AutoScreenshotTool.exe    # メイン実行ファイル（暗号化済み認証情報含む）
   └── run_with_password.bat     # パスワード入力補助スクリプト
   ```

## 従業員への配布

### 配布物
- `AutoScreenshotTool.exe`
- `run_with_password.bat`
- **パスワード**（別途、安全な方法で通知）

### 従業員の操作手順

#### 方法1: 最も簡単（推奨）
1. `run_with_password.bat` をダブルクリック
2. 通知されたパスワードを入力
3. 自動的にツールが起動

#### 方法2: 環境変数設定（上級者向け）
1. 環境変数 `SCREENSHOT_PASSWORD` にパスワードを設定
2. `AutoScreenshotTool.exe` を直接実行
3. パスワード入力不要で自動起動

#### 方法3: 直接実行
1. `AutoScreenshotTool.exe` をダブルクリック
2. プロンプトでパスワード入力
3. ツールが起動

## セキュリティ仕様

### 暗号化方式
- **アルゴリズム**: Fernet (AES-128)
- **鍵導出**: PBKDF2-SHA256（100,000回反復）
- **ソルト**: 16バイトのランダム値

### 保護される情報
- Googleサービスアカウントの認証情報
- APIアクセストークン
- プロジェクトID等の機密情報

### セキュリティポイント
- ✅ 元のJSONファイルは従業員に渡さない
- ✅ 暗号化された形でのみ配布
- ✅ パスワードは別経路で通知
- ✅ .gitignoreで誤コミット防止

## トラブルシューティング

### よくある問題

#### 「認証パスワードを入力してください」が表示されない
- **原因**: credentials.encが実行ファイルに含まれていない
- **解決**: prepare_for_employees_en.batで再ビルド

#### 「認証情報の取得に失敗しました」エラー
- **原因**: パスワードが間違っている
- **解決**: 正しいパスワードを入力

#### ツールが起動しない
- **原因**: Windows Defenderによるブロック
- **解決**: 
  1. Windowsセキュリティの設定を開く
  2. ウイルスと脅威の防止 → 除外の追加
  3. AutoScreenshotTool.exeを除外リストに追加

### ログ確認
エラーの詳細は `auto_screenshot.log` に記録されます：
```
例: [2024-01-25 10:30:00] 認証情報の取得に失敗しました: Invalid password
```

## ファイル構成

### 管理者環境
```
ScreenShot/
├── service-account-key.json      # 元の認証情報（機密）
├── credentials.enc               # 暗号化済み認証情報
├── auto_screenshot_gdrive.py     # メインプログラム
├── credential_manager.py         # 暗号化管理モジュール
├── prepare_for_employees_en.bat  # 配布準備スクリプト（英語版）
└── build_secure_en.bat          # セキュアビルドスクリプト（英語版）
```

### 従業員環境（配布後）
```
AutoScreenshot/
├── AutoScreenshotTool.exe       # 実行ファイル（認証情報含む）
├── run_with_password.bat        # 起動補助スクリプト
└── auto_screenshot.log          # 実行ログ（自動生成）
```

## セキュリティ注意事項

### 管理者向け
1. **service-account-key.json** は絶対に配布しない
2. パスワードは十分な強度のものを使用
3. パスワードの通知は安全な方法で（対面、電話等）
4. 配布後は元のJSONファイルを安全に保管または削除

### 従業員向け
1. パスワードは他人に教えない
2. 実行ファイルを外部に漏らさない
3. 退職時は実行ファイルを削除

## バッチファイルについて

### 文字エンコーディング問題への対応
Windows環境でのバッチファイル実行時に日本語文字が文字化けする問題を回避するため、英語版のバッチファイルを使用しています：
- `prepare_for_employees_en.bat`: 配布準備用（英語版）
- `build_secure_en.bat`: セキュアビルド用（英語版）

## 更新履歴
- v2.1: バッチファイルを英語版に統一（文字化け問題の解消）
- v2.0: パスワード認証方式に統一（シンプル化）
- v1.0: 初回リリース